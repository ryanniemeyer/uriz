<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="uriz : Example project to demonstrate Route53 + ELB + EC2 + DynamoDB + CloudFront + S3" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>uriz</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/ryanniemeyer/uriz">View on GitHub</a>

          <h1 id="project_title">uriz</h1>
          <h2 id="project_tagline">Example project to demonstrate Route53 + ELB + EC2 + DynamoDB + CloudFront + S3</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/ryanniemeyer/uriz/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/ryanniemeyer/uriz/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <p>uriz is a simple, non-production example of a URL shortener <a href="https://www.djangoproject.com/">Django</a> site. The purpose of this project is to walk someone through the steps for deploying a simple web app utilizing the following <a href="http://aws.amazon.com/">Amazon Web Services</a> (AWS):</p>

<ul>
<li>
<a href="http://aws.amazon.com/ec2/">EC2</a> for the web nodes</li>
<li>
<a href="http://aws.amazon.com/s3/">S3</a> + <a href="http://aws.amazon.com/cloudfront/">CloudFront</a> for static content</li>
<li>
<a href="http://aws.amazon.com/dynamodb/">DynamoDB</a> for storage</li>
<li>
<a href="http://aws.amazon.com/route53/">Route53</a> for DNS</li>
<li>
<a href="http://aws.amazon.com/elasticloadbalancing/">ELB</a> to balance load to the EC2 web nodes</li>
</ul><p>This tutorial assumes you've already created an <a href="http://aws.amazon.com/">AWS</a> account.</p>

<h2>Setup Your URL Shortener Domain</h2>

<p>The first step is obtaining a domain for your URL shortener from your favorite domain registrar (e.g. <a href="http://namecheap.com/">Namecheap</a>). I picked uriz.in, so you can simply fork this project and replace all occurrences of uriz.in with whatever your domain is.</p>

<p>After you've registered your domain, we'll switch its DNS over to Amazon <a href="http://aws.amazon.com/route53/">Route53</a> to make it easier to take advantage of other Amazon services.</p>

<p>Create a <a href="http://aws.amazon.com/route53/">Route53</a> hosted zone via the AWS console:</p>

<p><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/route53-1.png" alt="Route53 in AWS Console"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/route53-2.png" alt="Route53 new zone"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/route53-3.png" alt="Route53 name servers"></p>

<p>Then, change your domain's name servers to your <a href="http://aws.amazon.com/route53/">Route53</a> hosted zone's name servers:</p>

<p><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/namecheap-nameservers.png" alt="Namecheap Custom Name Servers"></p>

<p>Note that it may take a while for the DNS changes to propagate, which is why I put this step first.</p>

<h2>Data Storage</h2>

<p>Now that we've got our URL shortener domain and have it pointing to our Amazon DNS, let's set up our database. For this example we'll be using <a href="http://aws.amazon.com/dynamodb/">DynamoDB</a>, Amazon's high performance, scalable and reliable key-value store.</p>

<p>We'll have one table where our short URL tokens are the primary key and the value has metadata including the long URL, when the URL was first shortened and a count of how many times the short URL is visited. We'll also have a table that serves as a reverse index where the long URL is the primary key. There are certainly better ways to implement a URL shortener, but I'm not trying to demonstrate a bit.ly killer here, so bear with me.</p>

<p>You can use the <a href="http://aws.amazon.com/documentation/dynamodb/">DynamoDB APIs</a> or your favorite <a href="http://aws.amazon.com/">AWS</a> client SDK to add/remove/edit your tables, but for this example we'll use the web console to create our two tables (uriz and uriz_long):</p>

<p><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/dynamo-1a.png" alt="DynamoDB Console"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/dynamo-2.png" alt="DynamoDB Add uriz Table"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/dynamo-3.png" alt="DynamoDB Accept Defaults 1"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/dynamo-4.png" alt="DynamoDB Accept Defaults 2"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/dynamo-5.png" alt="DynamoDB Table Created"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/dynamo-6.png" alt="DynamoDB Add uriz_long Table"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/dynamo-7.png" alt="DynamoDB Both Tables Created"></p>

<p><a href="http://aws.amazon.com/documentation/dynamodb/">DynamoDB</a> has a nice <a href="http://aws.amazon.com/dynamodb/pricing/">free tier</a>, so this shouldn't cost you anything to play around with.</p>

<h2>Static Content</h2>

<p>Before we deploy our code, let's get our static content into <a href="http://aws.amazon.com/s3/">S3</a> and have it served up via Amazon's <a href="http://en.wikipedia.org/wiki/Content_delivery_network">CDN</a> (<a href="http://aws.amazon.com/cloudfront/">CloudFront</a>). In this example I simply have a single versioned CSS file. Probably the most amazing CSS anyone has ever or will ever create, I might add.</p>

<p>Checkout or clone this project (or your fork of this project) to your local machine. You'll need the project checked out to upload the s-1.css file in the uriz/static/css directory to <a href="http://aws.amazon.com/s3/">S3</a> and later to run the command that deploys to your web nodes.</p>

<p>After you get the code on your machine, go back to the AWS console and find the S3 service. Create a bucket with a css folder and upload s-1.css into it:</p>

<p><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/s3-1.png" alt="S3 Console"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/s3-2.png" alt="S3 New Bucket"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/s3-3.png" alt="S3 css Folder"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/s3-4.png" alt="S3 Upload CSS File"></p>

<p>Be sure to mark the css folder and the s-1.css file as public via the Actions drop down menu.</p>

<p>Now locate CloudFront in the AWS console. Create a distribution on top of that S3 bucket so your CSS is served as close to your users as possible:</p>

<p><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/cloudfront-1.png" alt="CloudFront console"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/cloudfront-2.png" alt="CloudFront Add Distribution"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/cloudfront-3.png" alt="CloudFront Caching"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/cloudfront-4.png" alt="CloudFront Confirm"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/cloudfront-5.png" alt="CloudFront Deployed"></p>

<p>In a production setting you'd want to automate the process of pushing your static content to <a href="http://aws.amazon.com/s3/">S3</a>, probably also doing things like compiling LESS/SASS, minifying, etc, but I'll leave that exercise to the reader. </p>

<h2>Deploy the Code!</h2>

<p>Ok, we've got our <a href="http://aws.amazon.com/dynamodb/">DynamoDB</a> tables out there, our static content served up via CloudFront and our domain is pointed to Amazon's DNS. Now let's deploy the uriz Django app to <a href="http://aws.amazon.com/ec2/">EC2</a>.</p>

<p>First thing we'll do is create a Key Pair that will allow us to SSH. This lets us deploy the code and log into the box should things go wrong. In the EC2 web console, go to the "Key Pairs" page and create a new pair. Name it uriz or something similar. When it downloads, save it to your local machine in the path /ec2/accounts/uriz/uriz.pem (if you want to save it somewhere else or pick a different Key Pair name, you'll simply need to change that path in uriz/fabfile.py mentioned below).</p>

<p>Next, we'll define a security group for our web nodes that tells each box to only open port 22 (SSH) and port 80 (HTTP). Do that via the "Security Groups" page in the EC2 console, making sure to click the Apply Changes button when you're done:</p>

<p><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/securitygroup-1.png" alt="Security Groups"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/securitygroup-2.png" alt="Add Security Group"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/securitygroup-3.png" alt="Open Ports 22 and 80 in Security Group"></p>

<p>Now we're ready to launch a new machine in the cloud. In this example I'm using a bare bones Ubuntu 12.04, 64-bit instance storage Amazon Machine Image (AMI) ami-3c994355. Let's launch a single box using the Key Pair and security group we just created:</p>

<p><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/ec2-1.png" alt="EC2 Console"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/ec2-2.png" alt="EC2 Classic"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/ec2-3.png" alt="EC2 Choose AMI"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/ec2-4.png" alt="EC2 Choose Zone"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/ec2-5.png" alt="EC2 Take Defaults"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/ec2-6.png" alt="EC2 Choose Name"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/ec2-7.png" alt="EC2 Choose KeyPair"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/ec2-8.png" alt="EC2 Choose Security Group"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/ec2-9.png" alt="EC2 Confirm"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/ec2-10.png" alt="EC2 Launched"></p>

<p>Sweet! We've got an Ubuntu 12.04 small instance running! Make note of your new instance's Public DNS address, as you'll need to know that to deploy the code.</p>

<p>Now let's install everything our Django app needs to run. To do that, we're using <a href="http://fabfile.org/">fabric</a>, which is a really nice Python library for running SSH commands on remote or local hosts.</p>

<p>To run the fabric task that configures and deploys the uriz app to your new <a href="http://aws.amazon.com/ec2/">EC2</a> instance, you'll need a local Python environment that has <a href="http://fabfile.org/">fabric</a> installed. In general, this means follow the instructions you'll find all over the interwebs that walk you through:</p>

<ol>
<li>Installing Python 2.7</li>
<li>Installing easy_install</li>
<li>easy_install pip</li>
<li>pip install virtualenv</li>
<li>pip install virtualenvwrapper</li>
<li>mkvirtualenv uriz</li>
<li>workon uriz</li>
<li>pip install fabric</li>
</ol><p>Isn't Python packaging great? Once you've got those things working it is! Hopefully things get much easier to setup in Python 3.3+, but I digress.</p>

<p>One more thing we need to do before deploying the code is enter your Amazon account's access key/secret so the app can read and write to <a href="http://aws.amazon.com/dynamodb/">DynamoDB</a> via Amazon's APIs. You can retrieve your key/secret from your <a href="http://aws.amazon.com/">AWS</a> account's "Security Credentials" link, which is in the drop down in the upper right of most AWS console pages. After locating your key and secret, add a file to your local clone/fork of the uriz project inside of the uriz app named my_aws_settings.py. In my_aws_settings.py you'll need to define two variables, which should look something like this:</p>

<pre><code>AWS_ACCESS_KEY_ID = 'BZEDKIEFHLYIHZDQTQKB'
AWS_SECRET_ACCESS_KEY = 'FazbumeFuCCA14ED7ahBtd/evqyGSWCtwcugF7vJ'
</code></pre>

<p>(Don't worry, that isn't my actual key/secret and I've added my_aws_settings.py to this project's .gitingore, so it will only be on your local machine, not checked into github.)</p>

<p>The fabfile will use those variables to write a similar file to your deployed uriz web apps.</p>

<p>Alright, now let's setup our new <a href="http://aws.amazon.com/ec2/">EC2</a> boxes by running the newbox fabric command, passing in your instance's Public DNS address in the -H host(s) argument:</p>

<pre><code>$ workon uriz
$ cd ~/uriz
$ fab -H ec2-50-17-41-254.compute-1.amazonaws.com newbox
</code></pre>

<p>This command may take a few minutes to run, most of the time spent updating the OS and installing packages. After it's finished we can check if it worked.</p>

<p>We haven't told the DNS (<a href="http://aws.amazon.com/route53/">Route53</a>) about this new box yet, but we can hit it directly via the public IP. Visit that in your browser, e.g. <a href="http://50.17.41.254/">http://50.17.41.254/</a> if your instance's Public DNS address was ec2-50-17-41-254.compute-1.amazonaws.com. If everything went well you should see a state-of-the-art URL shortener that looks something like this:</p>

<p><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/uriz-direct-to-host.png" alt="uriz on instance ip"></p>

<p>Hitting the box directly works, but you obviously don't want to send users to that single machine's ip address, so let's point our domain's DNS to our <a href="http://aws.amazon.com/ec2/">EC2</a> instance(s). What we want to do here is use Amazon's <a href="http://aws.amazon.com/elasticloadbalancing/">Elastic Load Balancer (ELB)</a> so we can easily add and remove web nodes from our running website to handle changes in traffic and no-downtime upgrades and technology changes.</p>

<p>Creating a load balancer is fairly straight forward in the EC2 console:</p>

<p><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/elb-1.png" alt="ELB Console"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/elb-2.png" alt="ELB New"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/elb-3.png" alt="ELB Healthcheck"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/elb-4.png" alt="ELB Instances"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/elb-5.png" alt="ELB Confirm"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/elb-6.png" alt="ELB Status"></p>

<p>Now that our load balancer is created and our instance is "In Service", let's add this load balancer to our DNS so traffic for our domain starts hitting the <a href="http://aws.amazon.com/elasticloadbalancing/">ELB</a>. We'll point both the naked domain (uriz.in) and the www subdomain (<a href="http://www.uriz.in">www.uriz.in</a>) to our load balancer:</p>

<p><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/route53-4.png" alt="Route53 console"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/route53-5.png" alt="Route53 naked domain"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/route53-6.png" alt="Route53 www subdomain"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/route53-7.png" alt="Route53 domain"></p>

<p>After those changes, try hitting your URL shortener domain in your browser. It should work:</p>

<p><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/uriz-in-1.png" alt="uriz.in homepage"><img src="http://d283nftekqpxlr.cloudfront.net/img/github-pages/uriz-in-2.png" alt="uriz.in short url info page"></p>

<p>Sweet. We've got <a href="http://aws.amazon.com/route53/">Route53</a>-&gt;<a href="http://aws.amazon.com/elasticloadbalancing/">ELB</a>-&gt;<a href="http://aws.amazon.com/ec2/">EC2</a>+<a href="http://aws.amazon.com/dynamodb/">DynamoDB</a>+<a href="http://aws.amazon.com/cloudfront/">CloudFront</a> working. Our load balancer is only pointing to a single web node, which isn't cool because machines go down, especially boxes "in the cloud". Plus, this is the best URL shortener anyone has ever produced, so it's highly likely to go viral when Justin Bieber catches wind of it. We've got to be ready for his tweets!</p>

<p>Follow the steps above to create another <a href="http://aws.amazon.com/ec2/">EC2</a> instance and run the newbox fabric command on your new box's host. After your new box is up and running, go back to the Load Balancers section of the <a href="http://aws.amazon.com/ec2/">EC2</a> console and add your new box to your existing load balancer. It should now be very easy to add/remove as many web nodes as you need.</p>

<h2>Wrapping Up</h2>

<p>Now you're probably not going to survive a Bieber tweet with two small web nodes, but you're well on your way. The next move is creating AMIs and taking advantage of some of the <a href="http://aws.amazon.com/">AWS</a> auto scaling features. That's a bit advanced and can be tricky depending on what all you have in your stack, so I'll leave that to another example project for another day.</p>

<p>That's it! Not quite <a href="http://www.heroku.com/">Heroku</a> or <a href="https://developers.google.com/appengine/">App Engine</a> simple, but the trade off for the additional complexity is more control over the technologies you can use to construct your app. I'm a huge fan of <a href="http://aws.amazon.com/">AWS</a> and I hope this helps someone out there get started with some of these services.</p>

<p>O yeah, one more thing... Don't forget to shut down your EC2 instances if you're no longer needing them, the meter is running! Chances are <a href="http://uriz.in/">http://uriz.in/</a> won't be up when you read this, the point of this project is for you to deploy your own :)</p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">uriz maintained by <a href="https://github.com/ryanniemeyer">ryanniemeyer</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
